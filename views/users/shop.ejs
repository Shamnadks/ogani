<% if(typeof userData !=="undefined"){%>        
    <%-include("../layouts/userheaderlogout")%>
  <%}else{%>
    <%-include('../layouts/userheader')%>
  <%}%>
  <style>
    .pagination {
      display: flex;
      justify-content: center;
      margin: 20px 0;
    }
    
    .pagination-link {
      color: #333;
      padding: 8px 16px;
      margin: 0 4px;
      border-radius: 4px;
      text-decoration: none;
      background-color: #f2f2f2;
    }
    
    .pagination-link:hover {
      background-color: #ddd;
    }
    
    .pagination-link.active {
      background-color: #4CAF50;
      color: white;
    }
  </style>
        <div class="container">
            <div class="row">
                <div class="col-lg-3">
                    <div class="header__logo">
                        <a href="./index.html"><img src="img/logo.png" alt=""></a>
                    </div>
                </div>
                <div class="col-lg-6">
                    <nav class="header__menu">
                        <ul>
                            <li><a href="/home">Home</a></li>
                            <li class="/shop"><a href="/shop">Shop</a></li>

                          
                        </ul>
                    </nav>
                </div>
                <div class="col-lg-3">
                    <div class="header__cart">
                        <ul>
                            <li><a href="/wishlist"><i class="fa fa-heart"></i></a></li>
                            <li><a href="/cart"><i class="fa fa-shopping-bag"></i> </a></li>
                        </ul>
                      
                    </div>
                </div>
            </div>
            <div class="humberger__open">
                <i class="fa fa-bars"></i>
            </div>
        </div>
    </header>
    <!-- Header Section End -->

    <!-- Hero Section Begin -->
   
    <section class="hero hero-normal">
        <div class="container">
            <div class="row">
                <div class="col-lg-3">
                  <div class="filter-items filter-items-count" id="category-filters">
                          <% if(categories.length > 0){ %> <% for(let i=0;i<categories.length;i++){ %>
                              <div class="filter-item">
                                <div class="custom-control custom-radio ">
                                  <input type="radio" name="category"  
                                    value="<%= categories[i]._id %>" 
                                    id="cat- <%= categories[i]._id %>-radio"
                                    class="custom-control-input category-radio"
                                    <%if(categories[i]._id.toString()===categoryId){%>checked<%}%>
                                    >
                                  <label class="custom-control-label" for="cat- <%= categories[i]._id %>-radio"> <%= categories[i].name %> </label>
                                </div>
                              </div>
                              <% } %>

                          <% } %>
                          
                        </div>
                        <div class="toolbox-sort">
                            <div class="toolbox-right">
                                <div class="toolbox-sort">
                                  <label for="sortby">Sort by:</label>
                                  <div class="select-custom">
                                    <select name="sortby" id="sortby" class="form-control">
                                        <option value="" selected disabled>Select</option>
                                        <option value="lowprice">Price Low to High</option>
                                        <option value="highprice">Price High to Low</option>
                                      </select>
                                  </div>
                                </div>
                              </div>
                        </div>
                        
                </div>
               
                
                <div class="col-lg-9">
                    <div class="hero__search">
                        <div class="hero__search__form">
                            <form id="search-form" action="/shop" method="GET">
                                <input type="text" id="search" name="search" placeholder="What do you need?" value="<%= search %>">
                                <button type="submit" class="site-btn">SEARCH</button>
                              </form>
                        </div>
                    </div>
                </div>
                
              
            </div>
        </div>
    </section>
   
   
      
      
   
    <!-- Hero Section End -->

    <!-- Breadcrumb Section Begin -->
    <section class="breadcrumb-section set-bg" data-setbg="img/breadcrumb.jpg">
        <div class="container">
            <div class="row">
                <div class="col-lg-12 text-center">
                    <div class="breadcrumb__text">
                        <h2>Organi Shop</h2>
                        <div class="breadcrumb__option">
                            <a href="/home">Home</a>
                            <span>Shop</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <!-- Breadcrumb Section End -->

    <!-- Product Section Begin -->
    <section class="product spad">
        <div class="container">
            <div class="row">
               
                <div class="col-lg-12 col-md-12">
                    
                    <div class="filter__item">
                        <div class="row">


                            <div class="col-lg-3">
                    
                                <div class="hero__categories">
                                    <div class="toolbox-right">
                    
                  </div>
                            </div>
                        
                            <div class="col-lg-4 col-md-4">
                                <div class="filter__found">
                                    <% if(products.length==0){%>
                                        <h6><span></span> Products Not found</h6>
                                        <% }else{%>
                                            <h6><span><%=products.length %></span> Products found</h6>
                                        <%}%>
                                   
                                </div>
                            </div>
                           
                        </div>
                    </div>
                    <div class="row">
                        <% if(products.length> 0){%>                
                  
                            <% for(let i=0;i < products.length; i++){%>
                        <div class="col-lg-4 col-md-6 col-sm-6">
                            <div class="product__item">
                                <div class="product__item__pic set-bg" data-setbg="/images/<%=products[i].img1[0]%>">
                                    <ul class="product__item__pic__hover">
                                        <li><a  onclick="addtowishlist('<%= products[i]._id %>')"  ><i class="fa fa-heart"></i></a></li>
                                        <li><a href="/details?id=<%= products[i]._id%>"><i class="fa fa-retweet"></i></a></li>
                                       <% if(products[i].stock == 0){%>
                                        <li><a onclick=" addtocartalert()" ><i class="fa fa-shopping-cart"></i></a></li>
                                      <% }else{%>
                                            <li><a onclick=" addtocart('<%= products[i]._id %>')" ><i class="fa fa-shopping-cart"></i></a></li>
                                      <% }%>
                                       
                                    </ul>
                                </div>
                                <div class="product__item__text">
                                    <h6><%= products[i].productName%></h6>
                                    <h5>Rs.<%= products[i].price %></h5>
                                </div>
                               
                            </div>
                            
                        </div>
                        <%}%>
                   <%}%>
                
                        
                    </div>
                    <div class="product__pagination">
                       
                    </div>
                </div>
            </div>
        </div>
        <div class="pagination">
            <nav aria-label="Page navigation" id="pagination">
                <ul class="pagination justify-content-center">
                  <li class="page-item">
                    <% if (currentPage > 1) { %>
                      <a class="page-link page-link-prev"
                      href="/shop?category=<%=categoryId%>&sortBy=<%=sortBy%>&search=<%= search %>&page=<%= previous %>"
                      aria-label="Previous"
                      tabindex="-1"
                      aria-disabled="true">
                      <span aria-hidden="true"
                      ><i class="icon-long-arrow-left"></i></span
                    >Prev</a>
                    <% } else { %>
                      <span class="page-link page-link-next" aria-label="Previous" aria-hidden="true">
                        <i class="icon-long-arrow-left"></i>Prev</span>
                    <% } %>   </li>
                  <%for(let i=1;i<=totalPages;i++){%>
                    <%if(i==currentPage){%>
                      <li class="page-item active page-link" aria-current="page"><%=i%></li>
                      <%}else{%>
                        <li class="page-item active" aria-current="page">
                          <a class="page-link" href="?category=<%=categoryId%>&sortBy=<%=sortBy%>&search= <%=search%>&page=<%=i%>"><%= i %></a>
                        </li> 
                        <%}%>   
                                       
                  <%}%><li class="page-item"> 
                    <% if (currentPage < totalPages) { %>
                      <a class="page-link page-link-next"
                      href="/shop?category=<%=categoryId%>&sortBy=<%=sortBy%>&search=<%= search %>&page=<%= next %>"
                      aria-label="Next">Next
                      <span aria-hidden="true"
                      ><i class="icon-long-arrow-right"></i>
                      </span>
                    </a>
                    <% } else { %>
                      <span class="page-link page-link-next" aria-label="Next" aria-hidden="true">Next 
                        <i class="icon-long-arrow-right"></i>
                        </span>
                    <% } %>   </li>
                </ul>
              </nav>
            </div>
        
    </section>
    
      
   
    <script src="js/jquery-3.3.1.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/jquery.nice-select.min.js"></script>
    <script src="js/jquery-ui.min.js"></script>
    <script src="js/jquery.slicknav.js"></script>
    <script src="js/mixitup.min.js"></script>
    <script src="js/owl.carousel.min.js"></script>
    <script src="js/main.js"></script>

<script>
    async function addtowishlist(productId){
        let orderplacement = await fetch("/addtowishlist", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(
                {
                    productId:productId  
                }
                ),
          });
          let result = await orderplacement.json();
          console.log("harsendra raj testing" + result);
          if (result.res === "success") {
            Swal.fire({
              title: "Success",
              text: "Item added successfully !",
              icon: "success",
              confirmButtonColor: "#3085d6",
              cancelButtonColor: "#d33",
              confirmButtonText: "OK",
              timer: 3000,
            })
          } else {
            Swal.fire({
              title: "Something went wrong",
              text: "something went wrong !",

              icon: "failure",
              confirmButtonColor: "#3085d6",
              cancelButtonColor: "#d33",
              confirmButtonText: "OK",
              timer: 3000,
            }).then((res) => {
              window.location.href = "/shop";
            });
          }
    }
</script>
<script>
    async function  addtocartalert(){
        Swal.fire({
              title: "Something went wrong",
              text: "Sorry Stock is not available.",

              icon: "failure",
              confirmButtonColor: "#3085d6",
              cancelButtonColor: "#d33",
              confirmButtonText: "OK",
              timer: 3000
        })
    }
</script>

<script>
    async function addtocart(productId){
      
        let orderplacement = await fetch("/addtocart", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(
                {
                    productId:productId  
                }
                ),
          });
          let result = await orderplacement.json()
          
          if (result.res === "success") {
            Swal.fire({
              title: "Success",
              text: "Item added successfully !",
              icon: "success",
              confirmButtonColor: "#3085d6",
              cancelButtonColor: "#d33",
              confirmButtonText: "OK",
              timer: 3000,
            })
          } else {
            Swal.fire({
              title: "Something went wrong",
              text: "something went wrong !",

              icon: "failure",
              confirmButtonColor: "#3085d6",
              cancelButtonColor: "#d33",
              confirmButtonText: "OK",
              timer: 3000,
            }).then((res) => {
              window.location.href = "/shop";
            });
          }
          
          
          }
    
</script>
<script>
    const sort = async (name) => {
      console.log("Sorting by: " + name);
      try {
        const response = await fetch("/shop", {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(
                {
                   name:name
                }
                )
            })
      } catch (error) {
        console.log(error);
      }
    }
  </script>

<script>
  const categoryRadios = document.querySelectorAll('.category-radio');
  const sortSelect = document.getElementById('sortby');
  const searchProduct = document.getElementById('search');
  
  // Get the current URL and parse the query parameters
  const urlParams = new URLSearchParams(window.location.search);
  const currentCategoryId = urlParams.get('category') || '';
  const currentSortValue = urlParams.get('sortBy') || '';
  const currentSearchValue = urlParams.get('search') || '';
  
  categoryRadios.forEach((radio) => {
    radio.addEventListener('change', () => {
      const categoryId = radio.value;
      const sortValue = sortSelect.value;
      const searchValue = searchProduct.value;
      if (categoryId !== currentCategoryId || sortValue !== currentSortValue || searchValue !== currentSearchValue) {
        // Only redirect if the values have changed
        const url = `/shop?category=${categoryId || ''}&sortBy=${sortValue}&search=${searchValue}`;
        searchProduct.value = ''; // clear search input
        window.location.href = url;
      }
    });
  });

  sortSelect.addEventListener('change', () => {
    const categoryId = currentCategoryId;
    const sortValue = sortSelect.value;
    const searchValue = searchProduct.value;
    if (sortValue !== currentSortValue || searchValue !== currentSearchValue) {
      // Only sort the products if the sort value has changed
      const productList = document.querySelector('.product-list');
      const products = Array.from(productList.children);
      const direction = sortValue === 'lowprice' ? 1 : -1;
      products.sort((a, b) => {
        const priceA = Number(a.querySelector('.product-price').textContent);
        const priceB = Number(b.querySelector('.product-price').textContent);
        return (priceA - priceB) * direction;
      });
      products.forEach((product) => {
        productList.appendChild(product);
      });
      currentSortValue = sortValue;
    }
  });
 
const searchInput = document.getElementById('search');


  // Add your search code here...
  searchInput.value = '';

</script>


</body>

</html>